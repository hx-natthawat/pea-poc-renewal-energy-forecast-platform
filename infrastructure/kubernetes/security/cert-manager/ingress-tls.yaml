# Ingress Configuration with TLS
# TOR Requirement: 7.1.3 - Secure Communications
#
# These Ingress resources enable HTTPS for all services.
# cert-manager automatically provisions certificates via annotations.
---
# Main PEA Forecast Application Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: pea-forecast-ingress
  namespace: pea-forecast
  labels:
    app.kubernetes.io/name: pea-forecast
    app.kubernetes.io/part-of: pea-re-forecast-platform
  annotations:
    # cert-manager integration
    cert-manager.io/cluster-issuer: "letsencrypt-production"
    # Kong Ingress Controller
    konghq.com/strip-path: "false"
    konghq.com/protocols: "https"
    # Force HTTPS redirect
    konghq.com/https-redirect-status-code: "301"
    # Security headers
    konghq.com/headers-content-security-policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
    konghq.com/headers-x-frame-options: "DENY"
    konghq.com/headers-x-content-type-options: "nosniff"
    konghq.com/headers-strict-transport-security: "max-age=31536000; includeSubDomains"
spec:
  ingressClassName: kong
  tls:
    - hosts:
        - pea-forecast.pea.co.th
        - api.pea-forecast.pea.co.th
      secretName: pea-forecast-tls
  rules:
    # Frontend UI
    - host: pea-forecast.pea.co.th
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 3000
    # Backend API
    - host: api.pea-forecast.pea.co.th
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 8000
---
# Grafana Ingress (monitoring namespace)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: pea-re-forecast-platform
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-production"
    konghq.com/protocols: "https"
    konghq.com/https-redirect-status-code: "301"
spec:
  ingressClassName: kong
  tls:
    - hosts:
        - grafana.pea-forecast.pea.co.th
      secretName: grafana-tls
  rules:
    - host: grafana.pea-forecast.pea.co.th
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000
---
# Prometheus Ingress (monitoring namespace)
# Note: Prometheus should be protected - consider adding authentication
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prometheus-ingress
  namespace: monitoring
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: pea-re-forecast-platform
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-production"
    konghq.com/protocols: "https"
    konghq.com/https-redirect-status-code: "301"
    # Basic auth plugin (configure in production)
    # konghq.com/plugins: prometheus-basic-auth
spec:
  ingressClassName: kong
  tls:
    - hosts:
        - prometheus.pea-forecast.pea.co.th
      secretName: prometheus-tls
  rules:
    - host: prometheus.pea-forecast.pea.co.th
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus
                port:
                  number: 9090
---
# Vault Ingress (vault namespace)
# Note: Vault UI should only be accessible to administrators
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vault-ingress
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/part-of: pea-re-forecast-platform
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-production"
    konghq.com/protocols: "https"
    konghq.com/https-redirect-status-code: "301"
spec:
  ingressClassName: kong
  tls:
    - hosts:
        - vault.pea-forecast.pea.co.th
      secretName: vault-tls
  rules:
    - host: vault.pea-forecast.pea.co.th
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: vault
                port:
                  number: 8200

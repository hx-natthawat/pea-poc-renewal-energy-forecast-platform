_format_version: "3.0"
_transform: true

# =============================================================================
# Kong Declarative Configuration
# Path-Based Routing for PEA RE Forecast Platform
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Backend API Service (FastAPI)
  # Route: /backend/* → backend:8000 (strip /backend prefix)
  # Frontend calls: /backend/api/v1/... → backend receives /api/v1/...
  # ---------------------------------------------------------------------------
  - name: backend-api
    url: http://host.docker.internal:8000
    routes:
      - name: backend-api-route
        paths:
          - /backend
        strip_path: true
        preserve_host: true
    plugins:
      - name: rate-limiting
        config:
          minute: 1000
          policy: local
      - name: cors
        config:
          origins:
            - "http://localhost:8888"
            - "http://localhost:3000"
            - "http://127.0.0.1:8888"
            - "http://127.0.0.1:3000"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
          headers:
            - Authorization
            - Content-Type
            - X-Request-ID
            - Accept
            - Origin
          exposed_headers:
            - X-Request-ID
          credentials: true
          max_age: 3600
          preflight_continue: false
      - name: request-transformer
        config:
          add:
            headers:
              - "X-Forwarded-Via: kong"

  # ---------------------------------------------------------------------------
  # Backend WebSocket Service
  # Route: /backend/api/v1/ws → backend:8000/api/v1/ws (WebSocket)
  # Separate route without CORS/rate-limiting for WebSocket compatibility
  # Kong handles WebSocket upgrade automatically with http/https protocols
  # ---------------------------------------------------------------------------
  - name: backend-ws
    url: http://host.docker.internal:8000/api/v1/ws
    routes:
      - name: backend-ws-route
        paths:
          - /backend/api/v1/ws
        strip_path: true
        preserve_host: true

  # ---------------------------------------------------------------------------
  # ML Service
  # Route: /ml/* → ml-service:8001
  # ---------------------------------------------------------------------------
  - name: ml-service
    url: http://host.docker.internal:8001
    routes:
      - name: ml-service-route
        paths:
          - /ml
        strip_path: true
        preserve_host: true
    plugins:
      - name: rate-limiting
        config:
          minute: 500
          policy: local
      - name: request-transformer
        config:
          add:
            headers:
              - "X-Forwarded-Via: kong"

  # ---------------------------------------------------------------------------
  # Frontend Service (Next.js)
  # Route: /console/* → frontend:3000 (explicit prefix for clean routing)
  # ---------------------------------------------------------------------------
  - name: frontend
    url: http://host.docker.internal:3000
    routes:
      - name: frontend-route
        paths:
          - /console
        strip_path: false
        preserve_host: true

# =============================================================================
# Global Plugins
# =============================================================================
plugins:
  # Add correlation ID to all requests
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true
